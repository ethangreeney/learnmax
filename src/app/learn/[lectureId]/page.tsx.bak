import prisma from '@/lib/prisma';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { notFound, redirect } from 'next/navigation';
import LearnView from '@/components/LearnView';

export default async function LearnPage({
  params,
}: {
  params: { lectureId: string };
}) {
  const session = await getServerSession(authOptions);
  if (!session || !session.user || !(session as SessionWithUser).user.id) {
    redirect('/api/auth/signin');
  }
  const userId = (session as SessionWithUser).user.id as string;

  const lecture = await prisma.lecture.findFirst({
    where: { id: params.lectureId, userId },
    include: {
      subtopics: {
        orderBy: { order: 'asc' },
        include: {
          questions: true,
          masteredBy: { where: { userId } },
        },
      },
    },
  });

  if (!lecture) {
    notFound();
  }

  // Normalize data for the client component
  const initial = {
    id: lecture.id,
    title: lecture.title,
    originalContent: lecture.originalContent,
    subtopics: lecture.subtopics.map((s) => ({
      id: s.id,
      order: s.order,
      title: s.title,
      importance: s.importance,
      difficulty: s.difficulty,
      overview: s.overview,
      explanation: s.explanation || '',
      mastered: s.masteredBy.length > 0,
      questions: s.questions.map((q) => ({
        id: q.id,
        prompt: q.prompt,
        options: q.options as unknown as string[],
        answerIndex: q.answerIndex,
        explanation: q.explanation,
      })),
    })),
  };

  return <LearnView initial={initial} />;
}
